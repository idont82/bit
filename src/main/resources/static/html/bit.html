<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=1400, initial-scale=1">
    
    <title>BIT</title>
  	<meta name="description" content="">
  	
	<!-- https://getbootstrap.kr/ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
	
	<link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.min.css" />
	<link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.bootstrap5.css" />
	<link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.3/css/buttons.bootstrap5.css" />
	
	<script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>
	<script src="https://cdn.datatables.net/2.3.2/js/dataTables.bootstrap5.js"></script>
	<script src="https://cdn.datatables.net/buttons/3.2.3/js/dataTables.buttons.js"></script>
	<script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.bootstrap5.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
	<script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.html5.min.js"></script>
	

	<script src="/js/common.js"></script>

    <style>
    	header {
		    padding-top: 7.5rem;
		    padding-bottom: 4rem;
		}
		.img_room {
		    width: 100%;
		    height: 90px;
		    margin-top: 1rem;
		}
    </style>
</head>

<body>

	<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" id="mainNav">
        <div class="container px-4">
            <a class="navbar-brand" href="#page-top">BIT</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto">
              
                    <li class="nav-item"><a class="nav-link" href="#services">Search</a></li>
                    <li class="nav-item"><a class="nav-link" href="#div_mapArea">Map</a></li>
                </ul>
            </div>
        </div>
    </nav>
    
    <header style="display:none;" class="bg-primary bg-gradient text-white">
            <div class="container px-4 text-center">
                <h1 class="fw-bolder">Welcome</h1>
                <p class="lead"></p>
                <a class="btn btn-dark" href="mailto:﻿idont82@gmail.com">Request a question by email</a>
             </div>

    </header>
        
	<div class="container mt-5   mb-5">
	  	
	  <div class="row g-3 align-items-center mt-5">
	    
	    <div  class="col-auto">
	      
	      <div class="input-group ">
					<label class="input-group-text" for="inputGroupSelectCount1">이동평균 하락일수</label>
					<select id="sel_maCnt" class="form-select" id="inputGroupSelectCount1">
					  <option value="" >All</option>
						<option value="1" >1일</option>
						<option value="3" >3일</option>
						<option value="5">5일</option>
						<option value="7">7일</option>
						<option value="14" selected>14일</option>
						<option value="30">30일</option>
						<option value="60">60일</option>
						<option value="90">90일</option>
					</select>
				</div>
			</div>
			<div  class="col-auto">
	  		<div class="input-group ">
					<label class="input-group-text" for="inputGroupSelectCount">갯수</label>
					<select id="sel_monitorCnt" class="form-select" id="inputGroupSelectCount">
					  <option value="9999" selected>All</option>
						<option value="50" >50개</option>
						<option value="100" >100개</option>
						<option value="200">200개</option>
						<option value="300">300개</option>
						<option value="400">400개</option>
					</select>
				</div>
				
			</div>
			<div  class="col-auto">
	  		<div class="input-group ">
					<label class="input-group-text" for="inputGroupSelectAmt">거래금액</label>
					<select id="sel_monitorAmt" class="form-select" id="inputGroupSelectAmt">
					  <option value="100000000" >1억 이상</option>
						<option value="300000000" >3억 이상</option>
						<option value="500000000" >5억 이상</option>
						<option value="1000000000" selected>10억 이상</option>
						<option value="5000000000">50억 이상</option>
						<option value="10000000000">100억 이상</option>
					</select>
				</div>
				
			</div>
			<div  class="col">
			  <button id="btn_search" class="btn btn-primary align-middle ms-2">Search</button>
			</div>
			<div class="col">
				
			</div>
			<div class="col-auto">
				  <span id="txt_nowSearch"> </span>
			</div>
		</div>
		
	
		<div class="row mt-5">
			<table id="myTable" class="display">
			    <thead>
			    </thead>
			    <tbody>
			    </tbody>
			</table>
		</div>
		
		<div class="row g-3 align-items-center mt-5 border-top border-secondary">
			<span></span>
		</div>
		
    <div id="services" class="row g-3 align-items-center">
	  		
	  	<div  class="col-auto">
	  		<div class="input-group ">
					<label class="input-group-text" for="inputGroupSelect01">단위</label>
					<select id=sel_candlesType class="form-select" id="inputGroupSelect01">
						<option value="minutes" selected>분</option>
						<option value="days">일</option>
						<option value="weeks">주</option>
						<option value="months">월</option>
					</select>
				</div>
			</div>
			
			<div  class="col-auto">
	  		<div class="input-group ">
					<label class="input-group-text" for="inputGroupSelect02">분단위</label>
					<select id="sel_minutes" class="form-select" id="inputGroupSelect02">
						<option value="1" >1분</option>
						<option value="3" >3분</option>
						<option value="5" >5분</option>
						<option value="10" >10분</option>
						<option value="15" >15분</option>
						<option value="30" selected>30분</option>
						<option value="60" >1시간</option>
						<option value="240" >4시간</option>
					</select>
				</div>
				
			</div>
		  <div class="col-auto">
		  		<div class="input-group ">
					<label class="input-group-text" for="inputGroupSelect03">갯수</label>
					<select id="sel_count" class="form-select" id="inputGroupSelect03">
					  <option value="10" selected>10개</option>
						<option value="50" >50개</option>
						<option value="100" >100개</option>
						<option value="200">200개</option>
					</select>
				</div>
			</div>
			<div class="col-auto">
		  		<div class="input-group ">
					<label class="input-group-text" for="inputGroupSelect04">상승률</label>
					<select id="sel_upPer" class="form-select" id="inputGroupSelect04">
						<option value="1" selected>1%</option>
						<option value="2" >2%</option>
						<option value="3" >3%</option>
						<option value="5" >5%</option>
						<option value="7">7%</option>
					</select>
				</div>
			</div>
			<div  class="col-auto">
			  <button id="btn_monitor" class="btn btn-success align-middle ms-2">Monitor</button>
			</div>
			<div class="col-auto">
		  		<div class="input-group ">
					<label class="input-group-text" for="inputGroupSTime">인터벌시간</label>
					<select id="sel_intervalTime" class="form-select" id="inputGroupSTime">
						<option value="1000" >1초</option>
						<option value="10000" >10초</option>
						<option value="30000" selected>30초</option>
						<option value="60000" >1분</option>
						<option value="120000" >2분</option>
						<option value="180000" >3분</option>
						<option value="300000" >5분</option>
					</select>
				</div>
			</div>
			<div  class="col-auto">
			  <button id="btn_stop" class="btn btn-warning align-middle ms-2">Stop</button>
			</div>
			<div class="col">
				
			</div>
			<div class="col-auto">
				  <span id="txt_nowTime"> </span>
				  <span id="txt_nowCandel"> </span>
			</div>
		</div>
		
		<div class="row mt-5">
  		<table id="myTable2" class="display">
  		    <thead>
  		    </thead>
  		    <tbody>
  		    </tbody>
  		</table>
  	</div>
	
	</div>
  
  	

		
	<!-- toast -->
	<div class="toast-container position-fixed bottom-0 end-0 p-3">
	  <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="10000">
	    <div class="toast-header">
	      <svg aria-hidden="true" class="bd-placeholder-img rounded me-2" height="20" preserveAspectRatio="xMidYMid slice" width="20" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="#007aff"></rect></svg>
	      <strong class="me-auto">Message</strong>
	      <!--<small>11 mins ago</small>-->
	      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
	    </div>
	    <div class="toast-body">
	    </div>
	  </div>
	</div>
	
    <script>
    
    const toastLive = document.getElementById('liveToast');
    const toastBootstrap  = bootstrap.Toast.getOrCreateInstance(toastLive);
    const bit = {};
    
    toastMsg = function(str){
		$('.toast-body').text(str);
		toastBootstrap.show();
    }	
    
    $(document).ready(function() {
    	
      //조회
      //bit.selectAll();
      //bit.selectCaution();
        
      //1)테이블 생성
    	bit.table = $('#myTable').DataTable(
    			{ data: [],
    			order : [[ 5, "desc" ]],
    			pageLength: 10,
    			"columns": [
    		            { "data": "market" , title : "market"}, 
    		            { "data": "korean_name" , title : "korean" }, 
    		            //{ "data": "english_name" , title : "english"},
    		            //{ "data": "market_warning", title : "warning" },
    		            { "data": "is_decline_name", title : "상/하" },
    		            { "data": "diff_per", title : "차이%" },
    		            { "data": "candle_acc_trade_price", title : "오늘거래금액" },
    		            { "data": "candle_acc_trade_price_prev", title : "전일거래금액" },
    
    		      ],
    		      
    		  "columnDefs": [
  		    	//{ targets: 4 , render: $.fn.dataTable.render.number( ',' ) },
  		    	//{ targets: 5 , render: $.fn.dataTable.render.number( ',' ) },
  		    	//{ targets: 0,  data: null,  render: function (data, type, row, meta) {  return meta.row + 1;  }  }
  		    	{ targets: 4,  render: function (data, type, row, meta) {  if (type === 'display') { return data.toLocaleString('ko-KR', { maximumFractionDigits: 0}); } return data; }  },
  		    	{ targets: 5,  render: function (data, type, row, meta) {  if (type === 'display') { return data.toLocaleString('ko-KR', { maximumFractionDigits: 0}); } return data; }  },
  		      ]
				}
    	);
    	
    	$('#myTable tbody').on('click', 'tr', function() {
  			        // 클릭된 행(<tr>)의 데이터를 가져옵니다.
  			        var data = bit.table.row(this).data();
  
  			        if (data) { // data가 유효한 경우에만 실행
  			        	bit.selectCandles(data.market, $('#sel_candlesType').val(), $('#sel_minutes').val(), $('#sel_count').val());
  			        }
  		});
  		
    	//2)테이블 생성
    	bit.tableSlave = $('#myTable2').DataTable(
    			{ data: [],
    			order : [[ 7, "desc" ]],
    			pageLength: 30,
    			"columns": [
    		            //{ "data": "market" , title : "market"}, 
    		            { "data": "korean_name" , title : "korean" }, 
    		            { "data": "opening_price" , title : "시가" }, 
    		            { "data": "high_price" , title : "고가"},
    		            { "data": "low_price" , title : "저가"},
    		            { "data": "trade_price" , title : "종가"},
    		            //{ "data": "avg" , title : "avg"},
    		            { "data": "per" , title : "%"},
    		            { "data": "candle_date_time_kst", title : "기준시각" },
    		            { "data": "timestamp", title : "종료 시각", render: DataTable.render.datetime() },
    		            
    		      ],
    		  "columnDefs": [
    		      { targets: 1,  render: function (data, type, row, meta) {  if (type === 'display') { return data.toLocaleString('ko-KR', { maximumFractionDigits: 4}); } return data; }  },
  		    		{ targets: 2,  render: function (data, type, row, meta) {  if (type === 'display') { return data.toLocaleString('ko-KR', { maximumFractionDigits: 4}); } return data; }  },
  		    	  { targets: 3,  render: function (data, type, row, meta) {  if (type === 'display') { return data.toLocaleString('ko-KR', { maximumFractionDigits: 4}); } return data; }  },
  		        { targets: 4,  render: function (data, type, row, meta) {  if (type === 'display') { return data.toLocaleString('ko-KR', { maximumFractionDigits: 4}); } return data; }  },
  		        { targets: 5,  render: function (data, type, row, meta) {  if (type === 'display') { return data.toLocaleString('ko-KR', { maximumFractionDigits: 2}); } return data; }  },
  		       // { targets: 6,  render: function (data, type, row, meta) {  if (type === 'display') { return data.toLocaleString('ko-KR', { maximumFractionDigits: 0}); } return data; }  },
  		      
  		    	//{ targets: 0,  data: null,  render: function (data, type, row, meta) {  return meta.row + 1;  }  }
  		      ]
				}
    	);
    	
    	
      $("#btn_search").on('click', function(event) {
        bit.selectAll();
      });
        
      $("#btn_monitor").on('click', function(event) {
        var intervalTime = Number($("#sel_intervalTime").val());
        
        bit.itervalMonitor = setInterval(() => {
          bit.monitor();
        }, intervalTime);

        bit.monitor();
      });
      
      $("#btn_stop").on('click', function(event) {
        if(bit.itervalMonitor != null){
          clearInterval(bit.itervalMonitor);
        }
        
        $("#txt_nowTime").text("Stop");
      });
      
      
    	
    });
    
    //전체 조회
    bit.selectAll = function(){	

    	const options = {method: 'GET', headers: {accept: 'application/json'}};

    	fetch('https://api.bithumb.com/v1/market/all?isDetails=true', options)
    	  .then(response => response.json())
    	  .then(response => bit.maCheckList(response) )
    	  .catch(err => console.error(err));
    	
	
    };
    
    //아동평균 하락 체크
    bit.maCheckList = async function(marketList){
      
      bit.table.clear().draw();
      
      for(let m in marketList){
        
         $("#txt_nowSearch").text(marketList[m].market + ", " +m+ " / "+ (marketList.length-1));
  			  
        if( !marketList[m].market.startsWith("KRW") ) continue;
        if( parseInt($("#sel_monitorCnt").val()) <= m ) break;
        
        const res = await bit.checkMADeclining(marketList[m].market);
        console.log(res);
        if(res != null 
            && res["is_decline"] //하락여부
            && res["candle_acc_trade_price_prev"] >= Number($("#sel_monitorAmt").val())
            ) {
          const mergedObj = { ...marketList[m], ...res };
          
          bit.table.row.add(mergedObj).draw();
        }
        
        //console.log(market);
      }
      
    };
    
    // x일 동안 MA 하락했는지 체크
    bit.checkMADeclining = async function (market) {
      try {
        const count = parseInt($("#sel_maCnt").val())  ;
        const count2 = count * 2;
        const options = {
          method: 'GET',
          headers: {accept: 'application/json'}
        };
  
        // 60일치 데이터 가져오기 (30일 MA 계산용)
        const response = await fetch(
          `https://api.bithumb.com/v1/candles/days?market=${market}&count=${count2}`,
          options
        );
        
        const data = await response.json();
        
        if (data.length < count2) {
          console.log('데이터가 부족합니다.');
          return null;
        }
        
        // 각 일자별 MA(count일 기준) 계산 배열 생성
        // data[0]이 가장 최신 데이터임에 주의
        let maArray = [];
        for (let i = 0; i <= count; i++) {
          const sliceData = data.slice(i, i + count);
          const ma = sliceData.reduce((sum, d) => sum + d.trade_price, 0) / count;
          maArray.push(ma);
        }
    
        // maArray[0]은 오늘 MA, maArray[1]은 어제 MA, ... maArray[count]는 count일 전 MA
    
        // 연속 하락 여부 판단 (오늘부터 이전일까지 계속 하락)
        let isDecliningContinuously = true;
        let isRisingContinuously = true;
        for (let i = 0; i < count; i++) {
          if (maArray[i] >= maArray[i + 1]) {
            // 오늘 MA가 어제 MA 이상이면 하락 연속 아님
            isDecliningContinuously = false;
          }
          if (maArray[i] <= maArray[i + 1]) {
            // 오늘 MA가 어제 MA 이하이면 상승 연속 아님
            isRisingContinuously = false;
          }
        }

        // 오늘 MA30 계산
        const todayMA30 = data.slice(0, count).reduce((sum, d) => sum + d.trade_price, 0) / count;
 
        // 30일 전 MA30 계산
        const ma30DaysAgo = data.slice(count, count2).reduce((sum, d) => sum + d.trade_price, 0) / count;
        
        // 하락 여부
        const isDecline = todayMA30 < ma30DaysAgo;
        const diff = todayMA30 - ma30DaysAgo;
        const percent = ((diff / ma30DaysAgo) * 100).toFixed(2);
        
        /*
        console.log('='.repeat(50));
        console.log(`마켓: ${market}`);
        console.log(`현재 MA30: ${Math.round(todayMA30).toLocaleString('ko-KR')}원`);
        console.log(`30일 전 MA30: ${Math.round(ma30DaysAgo).toLocaleString('ko-KR')}원`);
        console.log(`변화: ${Math.round(diff).toLocaleString('ko-KR')}원 (${percent}%)`);
        console.log('='.repeat(50));
        */
        
        console.log(`마켓: ${market}`);
        //console.log(data);
        /*
        if (isDecline) {
          console.log(count + '일 하락');
        } else {
          console.log(count + '일 상승');
        }*/
        let declineName = ""
        if (isDecliningContinuously) {
          declineName = `${count}일 연속 하락`;
          //console.log(`${count}일 연속 하락`);
        } else if (isRisingContinuously) {
          //console.log(`${count}일 연속 상승`);
          declineName = `${count}일 연속 상승`;
        } else {
          //console.log(`${count}일 연속 하락도 상승도 아님`);
        }
        
        console.log('='.repeat(50));
        
        data[0]["ma_today"] = Math.round(todayMA30);
        data[0]["ma_ago"] = Math.round(ma30DaysAgo);
        data[0]["is_decline"] = isDecliningContinuously ;
        data[0]["is_decline_name"] = declineName;
        data[0]["diff_amt"] = Math.round(diff);
        data[0]["diff_per"] = percent;
        data[0]["candle_acc_trade_price_prev"] = data[1]["candle_acc_trade_price"];//전일
        
        return data[0];
        
      } catch (error) {
        console.error('에러:', error);
        return null;
      }
    }

    bit.tableDraw = function(response){
      
      //1)테이블 생성
    	bit.table = $('#myTable').DataTable(
    			{ data: response,
    			order : "",
    			pageLength: 10,
    			"columns": [
    		            { "data": "market" , title : "market"}, 
    		            { "data": "korean_name" , title : "korean" }, 
    		            { "data": "english_name" , title : "english"},
    		            { "data": "market_warning", title : "warning" }
    		      ],
				}
    	);
    	
      
    };
    
    //전체 조회 그리기
    bit.monitor = function(){
      
      //bit.tableSlave.clear().draw();
      
      $("#txt_nowTime").text(new Date().toLocaleTimeString());
      
      bit.table.rows().every(function() {
          var data = this.data(); // Get the data object for the current row
          var rowNode = this.node(); // Get the HTML node for the current row
      
          console.log("Row Data:", data);
          console.log("Row Node:", rowNode);
          
          if (data) { // data가 유효한 경우에만 실행
  			        bit.selectCandles(data.market, data.korean_name, $('#sel_candlesType').val(), $('#sel_minutes').val(), $('#sel_count').val());
  			   }
      
      });
    };
    
    //전체 조회 그리기
    bit.loop = function(response){
		
 
    	//console.log(response);
    	//return;
    	
    	//2)시세
      let index = 1;
      let totalCnt = $("#sel_monitorCnt").val() == "" ? response.length : $("#sel_monitorCnt").val();
      function callNext() {
          if (index > totalCnt || index > response.length) return;

          const r = response[index-1];
          console.log(index + " : " + r.market);
          $("#txt_nowCandel").text(r.market + " " +index+ "/"+totalCnt);
          bit.selectCandles(r.market, $('#sel_candlesType').val(), $('#sel_minutes').val(), $('#sel_count').val());

          index++;
          setTimeout(callNext, 200); // 0.2초 후 다음 호출
      }

      callNext();
    }
    
    bit.selectCandles = function(market, koreanName, candleType, minutes, count){	
      
      if(candleType == "minutes"){
        minutes = "/" + minutes;
      }else{
        minutes = "";
      }
      
    	const options = {method: 'GET', headers: {accept: 'application/json'}};
      
    	fetch('https://api.bithumb.com/v1/candles/'+candleType+minutes+'?market='+market+'&count=' + count, options)
    	  .then(response => response.json())
    	  .then(response => bit.tradePer(response, koreanName))
    	  .catch(err => console.error(err));
	
    };
    
    
    //상승률 체크 
  	bit.tradePer = function(response, koreanName){
  		let prePrice = 0;
  		let count = response.length-1;
  		for(let i=count; i>=0; i--){
  		  const r = response[i];
        if(i == 0){
          const per =  (r["trade_price"] / prePrice -1)*100;
          console.log( "prePrice= "+ prePrice);
          console.log( "trade_price= "+ r["trade_price"]);
  			  console.log( "per= "+ per);
  			  console.log( "market= "+ r.market);
  			  console.log( "koreanName= "+ koreanName);
  			  
  			  $("#txt_nowCandel").text(r.market + ", Pre:" +prePrice+ " / Now:"+r["trade_price"] + ", " + per.toFixed(1) + "%");
  			  
  			  if( Number($("#sel_upPer").val()) <= per ){
  			    r.per = per;
  			    r["korean_name"] = koreanName;
  			    bit.tableSlave.row.add(r).draw();
  			   
  			  }
  			  
        }else{
          prePrice = r["trade_price"];
        }
        
  		}
      
  	};
    
  	//거래량 체크 - 평균보다 높은 경우
  	bit.volume = function(response){
  		let vol = 0;
  		let count = response.length-1;
  		for(let i=count; i>=0; i--){
  		  const r = response[i];
  	    //console.log( r["candle_date_time_kst"] + "  " + r["candle_acc_trade_volume"]);
        if(i == 0){
          let avg = vol / response.length-1;
          console.log( "vol Avg= "+ avg);
          if(avg < r["candle_acc_trade_volume"]){
    			  console.log( r);
    			  r["avg"] = avg;
    			  r["per"] = (avg / r["candle_acc_trade_volume"] * 100).toFixed(1);
    			  //평균보다 높으면 담기
    			  bit.tableSlave.Rows.InsertAt(r, 0);
          }
  			  
        }else{
          vol += r["candle_acc_trade_volume"];
        }
        
  		}
      
  	};

    bit.selectCaution = function(market){	

    	const options = {method: 'GET', headers: {accept: 'application/json'}};

    	fetch('https://api.bithumb.com/v1/market/virtual_asset_warning', options)
    	  .then(response => response.json())
    	  .then(response => console.log(response))
    	  .catch(err => console.error(err));
	
    };
    
    </script>
</body>

</html>
