<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=1400, initial-scale=1">
    
    <title>BIT</title>
  	<meta name="description" content="">
  	
	<!-- https://getbootstrap.kr/ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
	
	<link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.dataTables.min.css" />
	<link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.bootstrap5.css" />
	<link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.2.3/css/buttons.bootstrap5.css" />
	
	<script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>
	<script src="https://cdn.datatables.net/2.3.2/js/dataTables.bootstrap5.js"></script>
	<script src="https://cdn.datatables.net/buttons/3.2.3/js/dataTables.buttons.js"></script>
	<script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.bootstrap5.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
	<script src="https://cdn.datatables.net/buttons/3.2.3/js/buttons.html5.min.js"></script>
	

	<script src="/js/common.js"></script>

    <style>
    	header {
		    padding-top: 7.5rem;
		    padding-bottom: 4rem;
		}
		.img_room {
		    width: 100%;
		    height: 90px;
		    margin-top: 1rem;
		}
    </style>
</head>

<body>

	<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" id="mainNav">
        <div class="container px-4">
            <a class="navbar-brand" href="#page-top">BIT</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto">
              
                    <li class="nav-item"><a class="nav-link" href="#services">Search</a></li>
                    <li class="nav-item"><a class="nav-link" href="#div_mapArea">Map</a></li>
                </ul>
            </div>
        </div>
    </nav>
    
    <header style="display:none;" class="bg-primary bg-gradient text-white">
            <div class="container px-4 text-center">
                <h1 class="fw-bolder">Welcome</h1>
                <p class="lead"></p>
                <a class="btn btn-dark" href="mailto:﻿idont82@gmail.com">Request a question by email</a>
             </div>

    </header>
        
	<div class="container mt-5   mb-5">
	  	
	  <div class="row g-3 align-items-center mt-5">
	    
	    <div  class="col-auto">
	      
	  		<div class="input-group ">
					<label class="input-group-text" for="inputGroupSelectCount">갯수</label>
					<select id="sel_monitorCnt" class="form-select" id="inputGroupSelectCount">
					  <option value="" >All</option>
						<option value="50" selected>50개</option>
						<option value="100" >100개</option>
						<option value="200">200개</option>
						<option value="300">300개</option>
						<option value="400">400개</option>
					</select>
				</div>
				
			</div>
			<div  class="col">
			  <button id="btn_start" class="btn btn-primary align-middle ms-2">Start</button>
			</div>
		</div>
		
	
		<div class="row mt-5">
			<table id="myTable" class="display">
			    <thead>
			    </thead>
			    <tbody>
			    </tbody>
			</table>
		</div>
		
		<div class="row g-3 align-items-center mt-5 border-top border-secondary">
			<span></span>
		</div>
		
    <div id="services" class="row g-3 align-items-center">
	  		
	  	<div  class="col-auto">
	  		<div class="input-group ">
					<label class="input-group-text" for="inputGroupSelect01">단위</label>
					<select id=sel_candlesType class="form-select" id="inputGroupSelect01">
						<option value="minutes" selected>분</option>
						<option value="days">일</option>
						<option value="weeks">주</option>
						<option value="months">월</option>
					</select>
				</div>
			</div>
			
			<div  class="col-auto">
	  		<div class="input-group ">
					<label class="input-group-text" for="inputGroupSelect02">분단위</label>
					<select id="sel_minutes" class="form-select" id="inputGroupSelect02">
						<option value="1" >1분</option>
						<option value="3" >3분</option>
						<option value="5" >5분</option>
						<option value="10" selected>10분</option>
						<option value="15" >15분</option>
						<option value="30" >30분</option>
						<option value="60" >1시간</option>
						<option value="240" >4시간</option>
					</select>
				</div>
				
			</div>
		  <div class="col-auto">
		  		<div class="input-group ">
					<label class="input-group-text" for="inputGroupSelect03">갯수</label>
					<select id="sel_count" class="form-select" id="inputGroupSelect03">
						<option value="50" >50개</option>
						<option value="100" selected>100개</option>
						<option value="200">200개</option>
					</select>
				</div>
			</div>
			<div class="col">
				
			</div>
			<div class="col-auto">
				  <span id="txt_nowCandel"> </span>
			</div>
		</div>
		
		<div class="row mt-5">
  		<table id="myTable2" class="display">
  		    <thead>
  		    </thead>
  		    <tbody>
  		    </tbody>
  		</table>
  	</div>
	
	</div>
  
  	

		
	<!-- toast -->
	<div class="toast-container position-fixed bottom-0 end-0 p-3">
	  <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="10000">
	    <div class="toast-header">
	      <svg aria-hidden="true" class="bd-placeholder-img rounded me-2" height="20" preserveAspectRatio="xMidYMid slice" width="20" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="#007aff"></rect></svg>
	      <strong class="me-auto">Message</strong>
	      <!--<small>11 mins ago</small>-->
	      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
	    </div>
	    <div class="toast-body">
	    </div>
	  </div>
	</div>
	
    <script>
    
    const toastLive = document.getElementById('liveToast');
    const toastBootstrap  = bootstrap.Toast.getOrCreateInstance(toastLive);
    const bit = {};
    
    toastMsg = function(str){
		$('.toast-body').text(str);
		toastBootstrap.show();
    }	
    
    $(document).ready(function() {
    	
        //조회
        //bit.selectAll();
        //bit.selectCaution();
        
        $("#btn_start").on('click', function(event) {
          bit.selectAll();
        });
        
    	
    });
    
    //전체 조회
    bit.selectAll = function(){	

    	const options = {method: 'GET', headers: {accept: 'application/json'}};

    	fetch('https://api.bithumb.com/v1/market/all?isDetails=true', options)
    	  .then(response => response.json())
    	  .then(response => bit.loop(response))
    	  .catch(err => console.error(err));
    	
	
    };
    
    //전체 조회 그리기
    bit.loop = function(response){
		
    	//1)테이블 생성
    	bit.table = $('#myTable').DataTable(
    			{ data: response,
    			pageLength: 10,
    			"columns": [
    					{ "data": "checkbox", title : "check" }, 
    		            { "data": "market" , title : "market"}, 
    		            { "data": "korean_name" , title : "korean" }, 
    		            { "data": "english_name" , title : "english"},
    		            { "data": "market_warning", title : "warning" }
    		      ],
    		    "columnDefs": [
    		            {
    		                "targets": 0, // 첫 번째 열
    		                "orderable": true,
    		                "render": function (data, type, row) {
    		                    return '<input type="checkbox" class="row-select" data-id="' + row.id + '" ' + (data == null || !data.selected ? '' : 'checked') + '>';
    		                }
    		            }
    		        ],
				}
    	);
    	
    	//2)테이블 생성
    	bit.tableSlave = $('#myTable2').DataTable(
    			{ data: [],
    			pageLength: 30,
    			"columns": [
    		            { "data": "market" , title : "market"}, 
    		            { "data": "candle_acc_trade_price" , title : "price" }, 
    		            { "data": "candle_acc_trade_volume" , title : "volume"},
    		            { "data": "avg" , title : "avg"},
    		            { "data": "per" , title : "%"},
    		            { "data": "candle_date_time_kst", title : "kst" }
    		      ]
				}
    	);
    	
  		$('#myTable tbody').on('click', 'tr', function() {
  			        // 클릭된 행(<tr>)의 데이터를 가져옵니다.
  			        var data = bit.table.row(this).data();
  
  			        if (data) { // data가 유효한 경우에만 실행
  			        	bit.selectCandles(data.market, $('#sel_candlesType').val(), $('#sel_minutes').val(), $('#sel_count').val());
  			        }
  		});
    	  
    	//console.log(response);
    	//return;
    	
    	//2)시세
      let index = 1;
      let totalCnt = $("#sel_monitorCnt").val() == "" ? response.length : $("#sel_monitorCnt").val();
      function callNext() {
          if (index > totalCnt || index > response.length) return;

          const r = response[index-1];
          console.log(index + " : " + r.market);
          $("#txt_nowCandel").text(r.market + " " +index+ "/"+totalCnt);
          bit.selectCandles(r.market, $('#sel_candlesType').val(), $('#sel_minutes').val(), $('#sel_count').val());

          index++;
          setTimeout(callNext, 200); // 0.2초 후 다음 호출
      }

      callNext();
    }
    
    bit.selectCandles = function(market, candleType, minutes, count){	

    	const options = {method: 'GET', headers: {accept: 'application/json'}};

    	fetch('https://api.bithumb.com/v1/candles/'+candleType+'/'+minutes+'?market='+market+'&count=' + count, options)
    	  .then(response => response.json())
    	  .then(response => bit.volume(response))
    	  .catch(err => console.error(err));
	
    };
    
  	//거래량 체크 - 평균보다 높은 경우
  	bit.volume = function(response){
  		let vol = 0;
  		let count = response.length-1;
  		for(let i=count; i>=0; i--){
  		  const r = response[i];
  	    //console.log( r["candle_date_time_kst"] + "  " + r["candle_acc_trade_volume"]);
        if(i == 0){
          let avg = vol / response.length-1;
          console.log( "vol Avg= "+ avg);
          if(avg < r["candle_acc_trade_volume"]){
    			  console.log( r);
    			  r["avg"] = avg;
    			  r["per"] = (avg / r["candle_acc_trade_volume"] * 100).toFixed(1);
    			  //평균보다 높으면 담기
    			  bit.tableSlave.row.add(r).draw();
          }
  			  
        }else{
          vol += r["candle_acc_trade_volume"];
        }
        
  		}
      
  	};

    bit.selectCaution = function(market){	

    	const options = {method: 'GET', headers: {accept: 'application/json'}};

    	fetch('https://api.bithumb.com/v1/market/virtual_asset_warning', options)
    	  .then(response => response.json())
    	  .then(response => console.log(response))
    	  .catch(err => console.error(err));
	
    };
    
    </script>
</body>

</html>
